name: OpenWrt Config SSH Build

on:
  workflow_dispatch:

jobs:
  build: # 使用最新的 Ubuntu Runner
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4
        with:
          repository: coolsnowwolf/lede
          path: lede
          # depth: 1 # 深度设为 1 加快克隆速度
    
      - name: Prepare Feeds and Environment
        run: |
          cd lede
          
          # 必须先执行 update
          sudo apt update
          
          # --- 磁盘清理操作：释放空间 ---
          echo "Cleaning up disk space..."
          # 移除大型预安装工具
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          # 清理APT缓存
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*
          
          # 安装编译依赖
          sudo apt install build-essential libncurses5-dev zlib1g-dev gawk git gettext python3 unzip file wget rsync -y
          
          # 更新并安装 Feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # 准备默认配置，生成一个基础 .config 文件
          make defconfig
    
      # --- !!! 关键步骤：启动 SSH 连接 !!! ---
      # 允许用户连接到 Runner 运行 make menuconfig
      - name: SSH to Runner to Run menuconfig
        uses: mxschmitt/action-tmate@v3
        # 确保该步骤执行，即使前一步失败也要执行
        if: ${{ always() }} 
        with:
          limit-access-to-actor: true # 限制只有您本人可以连接
