name: Build OpenWrt x86-64 Custom

on:
  workflow_dispatch:
    inputs:
      OPENWRT_BRANCH:
        description: "é€‰æ‹© OpenWrt åˆ†æ”¯ï¼ˆé»˜è®¤ masterï¼‰"
        required: false
        default: "master"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Clean up disk space
        run: |
          echo "ğŸ§¹ Cleaning up disk space..."
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache /usr/local/lib/android
          sudo apt-get clean
          df -h

      - name: Install build dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          sudo apt-get update
          sudo apt-get install -y build-essential clang flex bison g++ gawk gcc-multilib \
            gettext git libncurses5-dev libssl-dev python3 rsync unzip zlib1g-dev file wget
          # å…¼å®¹æ—§ Runnerï¼ˆUbuntu 22.04ï¼‰ï¼Œæœ‰ distutils æ—¶å®‰è£…ï¼Œæ— åˆ™è·³è¿‡
          sudo apt-get install -y python3-distutils || true

      - name: Clone OpenWrt source
        run: |
          echo "ğŸ“¥ Cloning OpenWrt source..."
          git clone https://github.com/openwrt/openwrt.git ${{ github.workspace }}/openwrt
          cd ${{ github.workspace }}/openwrt
          git fetch --all
          git checkout ${{ github.event.inputs.OPENWRT_BRANCH || 'master' }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Add custom packages
        run: |
          echo "ğŸ“¦ Adding luci-theme-argon and luci-app-openclash..."
          cd ${{ github.workspace }}/openwrt/package
          git clone --depth=1 https://github.com/jerrykuku/luci-theme-argon.git
          git clone --depth=1 https://github.com/vernesong/OpenClash.git luci-app-openclash

      - name: Configure target and remove unwanted packages
        run: |
          cd ${{ github.workspace }}/openwrt
          echo "âš™ï¸ Configuring build for N305 x86_64"
          rm -f .config
          cat >> .config <<EOF
          CONFIG_TARGET_x86=y
          CONFIG_TARGET_x86_64=y
          CONFIG_TARGET_x86_64_Generic=y

          # Add Argon theme
          CONFIG_PACKAGE_luci-theme-argon=y
          # Add OpenClash
          CONFIG_PACKAGE_luci-app-openclash=y
          # Add Chinese language packs
          CONFIG_PACKAGE_luci-i18n-base-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-opkg-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-firewall-zh-cn=y
          CONFIG_PACKAGE_luci-i18n-openclash-zh-cn=y

          # Remove unwanted packages
          CONFIG_PACKAGE_luci-theme-bootstrap=n
          CONFIG_PACKAGE_luci-theme-material=n
          CONFIG_PACKAGE_kmod-ath9k=n
          CONFIG_PACKAGE_kmod-ath10k=n
          CONFIG_PACKAGE_kmod-usb-printer=n
          EOF

          make defconfig

      - name: Download source packages
        run: |
          cd ${{ github.workspace }}/openwrt
          echo "â¬‡ï¸ Downloading all source packages..."
          make download -j8

      - name: Build firmware (single thread)
        run: |
          cd ${{ github.workspace }}/openwrt
          echo "ğŸ§± Building OpenWrt firmware (single-thread mode)..."
          make -j1 V=s 2>&1 | tee build.log

      - name: Show build result
        if: always()
        run: |
          cd ${{ github.workspace }}/openwrt
          echo "ğŸ“„ Last 50 lines of build log:"
          tail -n 50 build.log || echo "No build.log found."
          echo "ğŸ“ Firmware files:"
          find bin/targets/ -type f || echo "No firmware files found."
          df -h

      - name: Upload firmware artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: openwrt-n305-x86_64-firmware
          path: ${{ github.workspace }}/openwrt/bin/targets/x86/64/
